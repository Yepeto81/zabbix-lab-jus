---
- name: Instalar MariaDB Server y dependencias
  apt:
    name:
      - mariadb-server
      - mariadb-client
      - python3-mysqldb
    state: present
  when: not zabbix_db_external

- name: Habilitar e iniciar MariaDB
  service:
    name: mariadb
    state: started
    enabled: yes
  when: not zabbix_db_external

- name: Asegurar MariaDB (Remover usuarios an√≥nimos)
  mysql_user:
    name: ""
    host_all: yes
    state: absent
    login_unix_socket: /var/run/mysqld/mysqld.sock
  when: not zabbix_db_external

- name: Asegurar MariaDB (Remover BD de test)
  mysql_db:
    name: test
    state: absent
    login_unix_socket: /var/run/mysqld/mysqld.sock
  when: not zabbix_db_external

- name: Crear base de datos para Zabbix
  mysql_db:
    name: "{{ zabbix_db_name }}"
    encoding: utf8mb4
    collation: utf8mb4_bin
    state: present
    login_unix_socket: /var/run/mysqld/mysqld.sock
  when: not zabbix_db_external

- name: Crear usuario de base de datos para Zabbix
  mysql_user:
    name: "{{ zabbix_db_user }}"
    password: "{{ zabbix_db_pass }}"
    priv: "{{ zabbix_db_name }}.*:ALL"
    state: present
    host: "{{ 'localhost' if not zabbix_db_external else '%' }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
  when: not zabbix_db_external
